<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #0a0e27;
    --surface: #151a33;
    --surface2: #1e2542;
    --border: #2a3150;
    --text: #e8eaed;
    --text-muted: #8b92b0;
    --blue: #4c9aff;
    --green: #36b37e;
    --red: #ff5630;
    --yellow: #ffab00;
    --purple: #6554c0;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'IBM Plex Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
  .container {
    display: grid;
    grid-template-columns: 320px 1fr;
    height: 100vh;
  }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 8px;
  }
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 12px;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--red);
    animation: pulse 2s infinite;
  }
  .status-dot.connected {
    background: var(--green);
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .user-select {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }
  .user-select label {
    display: block;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 600;
  }
  .user-select select {
    width: 100%;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: 'IBM Plex Sans KR', sans-serif;
  }
  .user-select select:focus {
    outline: none;
    border-color: var(--blue);
  }

  .room-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
  }
  .room-list h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    padding: 12px;
    font-weight: 600;
  }
  .room-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .room-item:hover {
    border-color: var(--blue);
    background: rgba(76, 154, 255, 0.05);
  }
  .room-item.active {
    border-color: var(--blue);
    background: rgba(76, 154, 255, 0.1);
  }
  .room-item h4 {
    font-size: 15px;
    font-weight: 600;
  }
  .room-item .room-id {
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .create-room {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
  }
  .create-room input {
    width: 100%;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    margin-bottom: 8px;
  }
  .create-room input:focus {
    outline: none;
    border-color: var(--blue);
  }
  .create-room button {
    width: 100%;
    padding: 10px;
    background: var(--blue);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  .create-room button:hover {
    background: #3d8ee6;
  }

  /* â”€â”€â”€ CHAT AREA â”€â”€â”€ */
  .chat-area {
    display: flex;
    flex-direction: column;
    background: var(--bg);
  }
  .chat-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .chat-header h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .chat-header p {
    font-size: 13px;
    color: var(--text-muted);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .message {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 70%;
  }
  .message.me {
    align-self: flex-end;
    align-items: flex-end;
  }
  .message-sender {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
  }
  .message-bubble {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.5;
  }
  .message.me .message-bubble {
    background: var(--blue);
    border-color: var(--blue);
    color: #fff;
  }
  .message-time {
    font-size: 11px;
    color: var(--text-muted);
  }

  .chat-input-wrapper {
    padding: 20px 28px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }
  .typing-indicator {
    font-size: 13px;
    color: var(--green);
    padding: 0 0 8px 4px;
    min-height: 24px;
    font-style: italic;
  }
  .typing-indicator .dots {
    display: inline-block;
  }
  .typing-indicator .dots::after {
    content: '...';
    animation: dots 1.4s steps(4, end) infinite;
  }
  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }
  .chat-input-form {
    display: flex;
    gap: 12px;
  }
  .chat-input-form input {
    flex: 1;
    padding: 14px 18px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 14px;
  }
  .chat-input-form input:focus {
    outline: none;
    border-color: var(--blue);
  }
  .chat-input-form button {
    padding: 14px 24px;
    background: var(--blue);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  .chat-input-form button:hover {
    background: #3d8ee6;
  }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    gap: 12px;
  }
  .empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  /* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: var(--bg);
  }
  ::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
  }
</style>
</head>
<body>

<div class="container">
  <!-- â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â• -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">ì—°ê²° ëŒ€ê¸°ì¤‘...</span>
      </div>
    </div>

    <div class="user-select">
      <label>ì‚¬ìš©ì ì„ íƒ</label>
      <select id="userSelect">
        <option value="1">Alice</option>
        <option value="2">Bob</option>
      </select>
    </div>

    <div class="room-list">
      <h3>ì±„íŒ…ë°©</h3>
      <div id="roomList"></div>
    </div>

    <div class="create-room">
      <input type="text" id="roomNameInput" placeholder="ìƒˆ ì±„íŒ…ë°© ì´ë¦„..."/>
      <button onclick="createRoom()">ì±„íŒ…ë°© ìƒì„±</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â• CHAT AREA â•â•â•â•â•â•â•â• -->
  <div class="chat-area">
    <div class="chat-header">
      <h2 id="chatTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
      <p id="chatSubtitle">ì™¼ìª½ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="empty-state">
        <h3>ğŸ“­ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ê³  ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
      </div>
    </div>

    <div class="chat-input-wrapper">
      <div class="typing-indicator" id="typingIndicator"></div>
      <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled oninput="handleTyping()"/>
        <button type="submit" disabled>ì „ì†¡</button>
      </form>
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8081';
const WS_URL = 'http://localhost:8081/ws';

let stompClient = null;
let currentUserId = null;
let currentUserName = null;
let currentRoomId = null;
let jwtToken = null;
let rooms = [];
let currentSubscription = null; // â† êµ¬ë… ID ì €ì¥ìš© ì¶”ê°€
let typingSubscription = null; // â† íƒ€ì´í•‘ êµ¬ë… ID
let typingTimeout = null; // â† íƒ€ì´í•‘ íƒ€ì´ë¨¸
let typingUsers = new Set(); // â† í˜„ì¬ ì…ë ¥ ì¤‘ì¸ ì‚¬ìš©ìë“¤

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // ê¸°ë³¸ User 1ë¡œ ì—°ê²°
  await selectUser(1);
  
  // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
  await loadRooms();
}

async function selectUser(userId) {
  try {
    console.log('ğŸ‘¤ ì‚¬ìš©ì ì„ íƒ:', userId);
    
    // JWT ë°œê¸‰
    const url = `${API_BASE}/api/jwt/${userId}`;
    console.log('ğŸ”‘ JWT ìš”ì²­:', url);
    
    const response = await fetch(url);
    console.log('ğŸ”‘ JWT ì‘ë‹µ ìƒíƒœ:', response.status);
    
    if (!response.ok) {
      throw new Error(`JWT ë°œê¸‰ ì‹¤íŒ¨: ${response.status}`);
    }
    
    jwtToken = await response.text();
    currentUserId = userId;
    currentUserName = userId === 1 ? 'Alice' : 'Bob'; // â† ì‹¤ì œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
    
    console.log('âœ… JWT ë°œê¸‰ ì™„ë£Œ:', jwtToken.substring(0, 20) + '...');
    
    // WebSocket ì—°ê²°
    connectWebSocket();
  } catch (error) {
    console.error('âŒ JWT ë°œê¸‰ ì‹¤íŒ¨:', error);
    alert('ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WebSocket ì—°ê²°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWebSocket() {
  console.log('ğŸ”Œ WebSocket ì—°ê²° ì‹œë„:', WS_URL);
  console.log('ğŸ”‘ JWT í† í°:', jwtToken ? jwtToken.substring(0, 30) + '...' : 'null');
  
  const socket = new SockJS(WS_URL);
  stompClient = Stomp.over(socket);
  
  // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
  stompClient.debug = function(str) {
    console.log('ğŸ” STOMP:', str);
  };
  
  stompClient.connect(
    { Authorization: `Bearer ${jwtToken}` },
    function(frame) {
      console.log('âœ… WebSocket ì—°ê²° ì™„ë£Œ:', frame);
      updateStatus(true);
    },
    function(error) {
      console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
      updateStatus(false);
      
      // ì¬ì—°ê²° ì‹œë„
      setTimeout(() => {
        console.log('ğŸ”„ 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...');
        connectWebSocket();
      }, 5000);
    }
  );
}

function updateStatus(connected) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  
  if (connected) {
    dot.classList.add('connected');
    text.textContent = `${currentUserName} ì—°ê²°ë¨`;
  } else {
    dot.classList.remove('connected');
    text.textContent = 'ì—°ê²° ëŠê¹€';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì±„íŒ…ë°© ê´€ë¦¬
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRooms() {
  try {
    console.log('ğŸ“‹ ì±„íŒ…ë°© ëª©ë¡ ìš”ì²­ ì¤‘...');
    const response = await fetch(`${API_BASE}/api/chat/rooms`);
    console.log('ğŸ“‹ ì‘ë‹µ ìƒíƒœ:', response.status);
    
    if (!response.ok) {
      console.error('âŒ ì‘ë‹µ ì‹¤íŒ¨:', response.status, response.statusText);
      return;
    }
    
    rooms = await response.json();
    console.log('âœ… ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', rooms);
    renderRooms();
  } catch (error) {
    console.error('âŒ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

async function createRoom() {
  const input = document.getElementById('roomNameInput');
  const name = input.value.trim();
  
  if (!name) {
    alert('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  
  try {
    console.log('ğŸ—ï¸ ì±„íŒ…ë°© ìƒì„± ìš”ì²­:', name);
    const response = await fetch(`${API_BASE}/api/chat/rooms?name=${encodeURIComponent(name)}`, {
      method: 'POST'
    });
    console.log('ğŸ—ï¸ ì‘ë‹µ ìƒíƒœ:', response.status);
    
    if (!response.ok) {
      console.error('âŒ ìƒì„± ì‹¤íŒ¨:', response.status, response.statusText);
      alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    const room = await response.json();
    console.log('âœ… ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ:', room);
    
    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    await loadRooms();
    input.value = '';
  } catch (error) {
    console.error('âŒ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨:', error);
    alert('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

function renderRooms() {
  const container = document.getElementById('roomList');
  container.innerHTML = rooms.map(room => `
    <div class="room-item ${currentRoomId === room.id ? 'active' : ''}" onclick="selectRoom(${room.id}, '${room.name}')">
      <div>
        <h4>${room.name}</h4>
        <div class="room-id">ID: ${room.id}</div>
      </div>
    </div>
  `).join('');
}

async function selectRoom(roomId, roomName) {
  // ê¸°ì¡´ êµ¬ë… í•´ì œ
  if (currentSubscription) {
    console.log('ğŸ”´ ê¸°ì¡´ êµ¬ë… í•´ì œ:', currentRoomId);
    currentSubscription.unsubscribe();
    currentSubscription = null;
  }
  if (typingSubscription) {
    typingSubscription.unsubscribe();
    typingSubscription = null;
  }
  
  currentRoomId = roomId;
  typingUsers.clear();
  updateTypingIndicator();
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('chatTitle').textContent = roomName;
  document.getElementById('chatSubtitle').textContent = `Room ID: ${roomId}`;
  document.getElementById('messageInput').disabled = false;
  document.querySelector('.chat-input-form button').disabled = false;
  
  renderRooms();
  clearMessages();
  
  // ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ
  await loadPastMessages(roomId);
  
  // ìƒˆ ì±„íŒ…ë°© êµ¬ë…
  if (stompClient && stompClient.connected) {
    // ë©”ì‹œì§€ êµ¬ë…
    currentSubscription = stompClient.subscribe(`/sub/chat/${roomId}`, function(message) {
      console.log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :', message.body);
      const data = JSON.parse(message.body);
      displayMessage(data);
    });
    
    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° êµ¬ë…
    typingSubscription = stompClient.subscribe(`/sub/chat/${roomId}/typing`, function(message) {
      const data = JSON.parse(message.body);
      handleTypingIndicator(data);
    });
    
    console.log('âœ… ì±„íŒ…ë°©', roomId, 'êµ¬ë… ì‹œì‘');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleTyping() {
  if (!currentRoomId || !stompClient || !stompClient.connected) return;
  
  // íƒ€ì´í•‘ ì¤‘ ì‹ í˜¸ ì „ì†¡
  sendTypingStatus(true);
  
  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
  if (typingTimeout) {
    clearTimeout(typingTimeout);
  }
  
  // 2ì´ˆ í›„ íƒ€ì´í•‘ ì¤‘ì§€ ì‹ í˜¸ ì „ì†¡
  typingTimeout = setTimeout(() => {
    sendTypingStatus(false);
  }, 2000);
}

function sendTypingStatus(isTyping) {
  if (!stompClient || !stompClient.connected || !currentRoomId) return;
  
  const typingData = {
    roomId: currentRoomId,
    typing: isTyping
  };
  
  stompClient.send('/pub/chat.typing', {}, JSON.stringify(typingData));
}

function handleTypingIndicator(data) {
  // ë‚´ê°€ ë³´ë‚¸ íƒ€ì´í•‘ ì‹ í˜¸ëŠ” ë¬´ì‹œ
  if (data.userId === currentUserId) return;
  
  if (data.typing) {
    typingUsers.add(data.userName);
  } else {
    typingUsers.delete(data.userName);
  }
  
  updateTypingIndicator();
}

function updateTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  
  if (typingUsers.size === 0) {
    indicator.innerHTML = '';
  } else if (typingUsers.size === 1) {
    const userName = Array.from(typingUsers)[0];
    indicator.innerHTML = `${userName}ì´ ì…ë ¥ ì¤‘<span class="dots"></span>`;
  } else {
    indicator.innerHTML = `${typingUsers.size}ëª…ì´ ì…ë ¥ ì¤‘<span class="dots"></span>`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë©”ì‹œì§€ ì „ì†¡/ìˆ˜ì‹ 
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPastMessages(roomId) {
  try {
    console.log('ğŸ“œ ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ ì¤‘...', roomId);
    const response = await fetch(`${API_BASE}/api/chat/rooms/${roomId}/messages?size=50`);
    
    if (!response.ok) {
      console.error('âŒ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', response.status);
      return;
    }
    
    const messages = await response.json();
    console.log('âœ… ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ:', messages.length, 'ê°œ');
    
    // ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
    messages.sort((a, b) => {
      const dateA = new Date(a.createdAt);
      const dateB = new Date(b.createdAt);
      return dateA - dateB;
    });
    
    // ë©”ì‹œì§€ë¥¼ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
    messages.forEach(msg => {
      displayPastMessage(msg);
    });
    
    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
  } catch (error) {
    console.error('âŒ ê³¼ê±° ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

function sendMessage(event) {
  event.preventDefault();
  
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  
  if (!content || !currentRoomId) return;
  
  const message = {
    roomId: currentRoomId,
    content: content
  };
  
  stompClient.send('/pub/chat.send', {}, JSON.stringify(message));
  input.value = '';
  
  // íƒ€ì´í•‘ ì¤‘ì§€ ì‹ í˜¸ ì „ì†¡
  sendTypingStatus(false);
  if (typingTimeout) {
    clearTimeout(typingTimeout);
    typingTimeout = null;
  }
  
  console.log('ë©”ì‹œì§€ ì „ì†¡:', message);
}

function displayMessage(data) {
  const container = document.getElementById('chatMessages');
  
  // empty state ì œê±°
  const emptyState = container.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }
  
  const isMe = data.senderId === currentUserId;
  const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isMe ? 'me' : ''}`;
  messageDiv.innerHTML = `
    <div class="message-sender">${data.senderName}</div>
    <div class="message-bubble">${escapeHtml(data.content)}</div>
    <div class="message-time">${time}</div>
  `;
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

function displayPastMessage(data) {
  const container = document.getElementById('chatMessages');
  
  // empty state ì œê±°
  const emptyState = container.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }
  
  const isMe = data.senderId === currentUserId;
  
  // createdAt í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°„ í‘œì‹œ
  let time = 'ì˜¤í›„ 00:00';
  if (data.createdAt) {
    const date = new Date(data.createdAt);
    time = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isMe ? 'me' : ''}`;
  messageDiv.innerHTML = `
    <div class="message-sender">${data.senderName}</div>
    <div class="message-bubble">${escapeHtml(data.content)}</div>
    <div class="message-time">${time}</div>
  `;
  
  container.appendChild(messageDiv);
}

function clearMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = `
    <div class="empty-state">
      <h3>ğŸ“­ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ê³  ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
    </div>
  `;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì‚¬ìš©ì ë³€ê²½
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('userSelect').addEventListener('change', async function(e) {
  const userId = parseInt(e.target.value);
  
  // ê¸°ì¡´ êµ¬ë… í•´ì œ
  if (currentSubscription) {
    currentSubscription.unsubscribe();
    currentSubscription = null;
  }
  if (typingSubscription) {
    typingSubscription.unsubscribe();
    typingSubscription = null;
  }
  
  // ê¸°ì¡´ ì—°ê²° ëŠê¸°
  if (stompClient) {
    stompClient.disconnect();
  }
  
  // ìƒˆ ì‚¬ìš©ìë¡œ ì¬ì—°ê²°
  await selectUser(userId);
  currentRoomId = null;
  typingUsers.clear();
  clearMessages();
  
  // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  await loadRooms();
  
  document.getElementById('messageInput').disabled = true;
  document.querySelector('.chat-input-form button').disabled = true;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì‹œì‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>

</body>
</html>
